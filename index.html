<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å°æ€æ—¥è®° ğŸ’­</title>
  <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
  <style>
    :root {
      --main-pink: #FF9EAA;
      --sky-blue: #A2D9FF;
      --cream-bg: #FFF9F5;
      --text-dark: #5A5A5A;
      --success-green: #B0EACD;
      --light-gray: #f0f0f0;
      --purple: #C796FF;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Ma Shan Zheng', cursive;
      background-color: var(--cream-bg);
      color: var(--text-dark);
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      font-size: 2.2em;
      color: var(--main-pink);
      margin: 20px 0;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .settings-btn {
      background: var(--purple);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 20px;
      font-family: 'Ma Shan Zheng', cursive;
      cursor: pointer;
      font-size: 0.9em;
    }

    textarea {
      width: 100%;
      height: 120px;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 12px;
      font-family: inherit;
      font-size: 1.1em;
      resize: vertical;
      background-color: white;
    }

    .btn {
      display: block;
      width: 100%;
      padding: 12px;
      margin: 12px 0;
      border: none;
      border-radius: 12px;
      font-family: inherit;
      font-size: 1.2em;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .btn-save { background-color: var(--main-pink); color: #333; }
    .btn-ai { background-color: var(--sky-blue); color: #333; }
    .btn-history { background-color: var(--light-gray); color: #333; }
    .copy-btn { background-color: var(--success-green); color: #333; display: none; }

    .btn:hover { opacity: 0.9; }

    #output {
      background-color: white;
      padding: 15px;
      border-radius: 12px;
      min-height: 80px;
      margin-top: 10px;
      white-space: pre-wrap;
      line-height: 1.5;
    }

    .status {
      text-align: center;
      margin-top: 10px;
      font-size: 0.9em;
      color: #888;
    }

    /* å†å²è®°å½• */
    #historyPanel {
      margin-top: 20px;
      display: none;
    }

    .history-date {
      background-color: var(--light-gray);
      padding: 10px;
      margin-top: 10px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }

    .history-entries {
      padding: 10px;
      background-color: white;
      border-radius: 8px;
      margin-top: 5px;
      display: none;
    }

    .toggle-icon::after { content: " â–¼"; }
    .toggle-icon.open::after { content: " â–²"; }
  </style>
</head>
<body>
  <div class="top-bar">
    <h1>å°æ€æ—¥è®° ğŸ’­</h1>
    <button class="settings-btn" onclick="openSettings()">âš™ï¸ è®¾ç½®</button>
  </div>
  
  <textarea id="input" placeholder="å†™ä¸‹æ­¤åˆ»çš„æƒ³æ³•..."></textarea>
  
  <button class="btn btn-save" onclick="saveEntry()">ğŸ’¾ ä¿å­˜è®°å½•</button>
  
  <button class="btn btn-ai" onclick="generateSummary()">âœ¨ ç”Ÿæˆä»Šæ—¥åˆ›æ„</button>

  <button class="btn btn-history" onclick="toggleHistory()">ğŸ“– æŸ¥çœ‹å†å²è®°å½•</button>
  
  <div id="output">ç‚¹å‡»â€œç”Ÿæˆä»Šæ—¥åˆ›æ„â€æŸ¥çœ‹AIå»ºè®®ï½</div>
  
  <button class="btn copy-btn" onclick="copyOutput()" id="copyBtn">ğŸ“‹ å¤åˆ¶åˆ›æ„</button>
  
  <div class="status" id="status"></div>

  <div id="historyPanel"></div>

  <script>
    // ========== å·¥å…·å‡½æ•° ==========
    function getTodayKey() {
      return new Date().toISOString().split('T')[0];
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      const today = new Date();
      if (date.toDateString() === today.toDateString()) return 'ä»Šå¤©';
      if (date.getTime() > today.getTime() - 86400000) return 'æ˜¨å¤©';
      return dateStr;
    }

    function openSettings() {
      window.open('settings.html', '_blank', 'width=500,height=400');
    }

    // ========== æ ¸å¿ƒåŠŸèƒ½ ==========
    function saveEntry() {
      const content = document.getElementById('input').value.trim();
      if (!content) {
        alert('è¯·è¾“å…¥å†…å®¹ï½');
        return;
      }

      const today = getTodayKey();
      let entries = JSON.parse(localStorage.getItem('diary_entries') || '{}');
      if (!entries[today]) entries[today] = [];
      entries[today].push(content);
      localStorage.setItem('diary_entries', JSON.stringify(entries));

      document.getElementById('input').value = '';
      showStatus('å·²ä¿å­˜ï¼', 'green');
      renderHistory();
    }

    async function generateSummary() {
      const today = getTodayKey();
      const entries = JSON.parse(localStorage.getItem('diary_entries') || '{}');
      const todayEntries = entries[today] || [];

      if (todayEntries.length === 0) {
        document.getElementById('output').innerText = 'ä»Šå¤©è¿˜æ²¡æœ‰è®°å½•å“¦ï½å†™ç‚¹ä»€ä¹ˆå§ï¼âœ¨';
        document.getElementById('copyBtn').style.display = 'none';
        return;
      }

      const text = todayEntries.join('\n');
      const prompt = `
ä½ æ˜¯ä¸€ä½æ¸©æš–åˆæ‡‚å˜ç°çš„åˆ›æ„ä¼™ä¼´ã€‚è¯·æ ¹æ®ç”¨æˆ·ä»Šå¤©çš„ç¢ç‰‡æƒ³æ³•ï¼Œå®Œæˆä¸¤ä»¶äº‹ï¼š

1. ã€ä»Šæ—¥å°ç»“ã€‘ç”¨ä¸è¶…è¿‡50å­—ï¼Œæ¸©æŸ”åœ°æ€»ç»“ä»Šå¤©çš„æƒ…ç»ªæˆ–ä¸»é¢˜ã€‚
2. ã€åˆ›æ„å˜ç°ã€‘ç»™å‡º3ä¸ªå¯è½åœ°çš„åˆ›ä½œæ–¹å‘ï¼Œæ¯ä¸ªåŒ…å«ï¼š
   - ç±»å‹ï¼ˆå¦‚ï¼šå°çº¢ä¹¦ç¬”è®° / æŠ–éŸ³è„šæœ¬ / æ‰‹è´¦ç´ æ / Etsyæ•°å­—äº§å“ï¼‰
   - å…·ä½“å»ºè®®ï¼ˆå¦‚ï¼šâ€œæ‹ä¸€ä¸ªâ€˜æ·±å¤œçµæ„Ÿæ”¶é›†â€™çš„æ²»æ„ˆç³»Vlogï¼Œæ­é…é’¢ç´èƒŒæ™¯éŸ³ä¹â€ï¼‰

ç”¨æˆ·ä»Šæ—¥è®°å½•ï¼š
${text}
`;

      // ä»è®¾ç½®é¡µè¯»å–æ¨¡å‹å’Œ API Key
      const modelConfig = JSON.parse(localStorage.getItem('ai_model_config') || '{}');
      const { provider = 'moonshot', api_key } = modelConfig;

      if (!api_key) {
        alert('è¯·å…ˆåœ¨ âš™ï¸ è®¾ç½® ä¸­é…ç½® API Keyï¼');
        openSettings();
        return;
      }

      let apiUrl, model, headers, body;
      if (provider === 'deepseek') {
        apiUrl = 'https://api.deepseek.com/chat/completions';
        model = 'deepseek-chat';
        headers = {
          'Authorization': `Bearer ${api_key}`,
          'Content-Type': 'application/json'
        };
        body = JSON.stringify({
          model,
          messages: [{ role: 'user', content: prompt }],
          temperature: 0.7,
          max_tokens: 600
        });
      } else {
        // é»˜è®¤ Moonshot
        apiUrl = 'https://api.moonshot.cn/v1/chat/completions';
        model = 'moonshot-v1-8k';
        headers = {
          'Authorization': `Bearer ${api_key}`,
          'Content-Type': 'application/json'
        };
        body = JSON.stringify({
          model,
          messages: [{ role: 'user', content: prompt }],
          temperature: 0.7,
          max_tokens: 600
        });
      }

      showStatus(`ğŸŒ™ æ­£åœ¨è°ƒç”¨ ${provider === 'deepseek' ? 'DeepSeek' : 'Moonshot'}...`, 'blue');
      document.getElementById('output').innerText = 'æ­£åœ¨ç”Ÿæˆ...';

      try {
        const response = await fetch(apiUrl, { method: 'POST', headers, body });
        if (response.ok) {
          const data = await response.json();
          const result = data.choices[0].message.content.trim();
          document.getElementById('output').innerText = result;
          document.getElementById('copyBtn').style.display = 'block';
          showStatus('âœ¨ åˆ›æ„ç”ŸæˆæˆåŠŸï¼', 'green');
        } else {
          const errorText = await response.text();
          console.error('API Error:', errorText);
          document.getElementById('output').innerText = 'AI å‡ºé”™äº† ğŸ˜¢\nè¯·æ£€æŸ¥ API Key æˆ–é‡è¯•ã€‚';
        }
      } catch (err) {
        console.error('Network Error:', err);
        document.getElementById('output').innerText = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é‡è¯•ã€‚';
        showStatus('âŒ ç½‘ç»œé”™è¯¯', 'red');
      }
    }

    function copyOutput() {
      const text = document.getElementById('output').innerText;
      navigator.clipboard.writeText(text).then(() => {
        showStatus('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'green');
      });
    }

    function showStatus(msg, color) {
      const statusEl = document.getElementById('status');
      statusEl.innerText = msg;
      statusEl.style.color = 
        color === 'green' ? '#2E8B57' : 
        color === 'blue' ? '#1E90FF' : 'red';
      setTimeout(() => {
        if (statusEl.innerText === msg) statusEl.innerText = '';
      }, 3000);
    }

    function renderHistory() {
      const entries = JSON.parse(localStorage.getItem('diary_entries') || '{}');
      const sortedDates = Object.keys(entries).sort((a, b) => new Date(b) - new Date(a));
      
      const panel = document.getElementById('historyPanel');
      panel.innerHTML = '';

      if (sortedDates.length === 0) {
        panel.innerHTML = '<p style="text-align:center;color:#888;">æš‚æ— å†å²è®°å½•</p>';
        return;
      }

      sortedDates.forEach(date => {
        const div = document.createElement('div');
        div.className = 'history-date toggle-icon';
        div.textContent = formatDate(date);
        div.dataset.date = date;

        const entriesDiv = document.createElement('div');
        entriesDiv.className = 'history-entries';
        entriesDiv.innerHTML = entries[date].map(e => `<div>â€¢ ${e}</div>`).join('<br>');

        div.addEventListener('click', () => {
          div.classList.toggle('open');
          entriesDiv.style.display = div.classList.contains('open') ? 'block' : 'none';
        });

        panel.appendChild(div);
        panel.appendChild(entriesDiv);
      });
    }

    function toggleHistory() {
      const panel = document.getElementById('historyPanel');
      const isHidden = panel.style.display === 'none' || panel.style.display === '';
      panel.style.display = isHidden ? 'block' : 'none';
      renderHistory();
    }

    window.onload = () => {
      if (!localStorage.getItem('diary_entries')) {
        document.getElementById('output').innerText = 'æ¬¢è¿ä½¿ç”¨å°æ€æ—¥è®°ï¼\nå†™ä¸‹ä½ çš„ç¬¬ä¸€ä¸ªæƒ³æ³•å§ï½';
      }
    };
  </script>
</body>
</html>