<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°æ€æ—¥è®° | æ¯å¤©è®°å½•ï¼Œæ”¹å˜å‘½è¿</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            min-height: 100vh;
            padding: 15px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 20px;
            text-align: center;
            position: relative;
        }
        .header h1 { font-size: 28px; margin-bottom: 8px; font-weight: bold; }
        .header p { font-size: 14px; opacity: 0.9; }
        .stats-bar {
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 15px;
            margin-top: 10px;
            font-size: 13px;
        }
        .stats-bar span { margin: 0 8px; }
        .settings-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .settings-btn:hover { background: rgba(255,255,255,0.3); }
        
        /* æ ‡ç­¾åˆ‡æ¢ */
        .tab-nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        .tab-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: bold;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        .tab-btn.active {
            color: #667eea;
            background: white;
        }
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #667eea;
        }
        .tab-content { display: none; padding: 25px; }
        .tab-content.active { display: block; }

        .content { padding: 0; }
        .record-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 0 0 15px 15px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
            border-top: none;
        }
        .record-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        textarea {
            width: 100%;
            height: 150px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            resize: vertical;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-secondary {
            background: #e9ecef;
            color: #495057;
        }
        .btn-secondary:hover { background: #dee2e6; }
        .btn-success {
            background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
            color: white;
        }
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        /* å†å²è®°å½•æ ·å¼ */
        .history-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .date-picker {
            flex: 1;
            min-width: 150px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
        }
        .search-box {
            flex: 2;
            min-width: 200px;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            padding-left: 40px;
            background: white url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%236c757d" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>') no-repeat 15px center;
        }
        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }
        .history-item {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .history-date {
            font-size: 16px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f8f9fa;
        }
        .history-record {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 3px solid #ffc107;
        }
        .history-time {
            color: #6c757d;
            font-size: 13px;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .history-content {
            color: #212529;
            line-height: 1.6;
            word-break: break-word;
        }
        .history-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            justify-content: flex-end;
        }
        .record-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 15px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .edit-btn { background: #ffc107; color: #212529; }
        .delete-btn { background: #dc3545; color: white; }
        .view-btn { background: #17a2b8; color: white; }
        .edit-btn:hover, .delete-btn:hover, .view-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        /* æœˆä»½è§†å›¾ */
        .month-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .month-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            background: white;
            border: 1px solid #e9ecef;
        }
        .month-day:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .month-day.has-record {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        .month-day.today {
            border: 3px solid #ffc107;
            background: white;
            color: #667eea;
        }
        .month-day-name {
            font-weight: bold;
            color: #667eea;
            text-align: center;
            padding: 10px 0;
            font-size: 14px;
        }
        .month-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        .month-title {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }
        
        .records-list {
            margin-top: 0;
        }
        .records-list h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .record-item {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: relative;
        }
        .record-time {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .record-content {
            color: #212529;
            line-height: 1.6;
            margin-bottom: 15px;
            min-height: 60px;
            word-break: break-word;
        }
        .record-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .summary-section {
            margin-top: 25px;
            padding: 20px;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 15px;
            border: 2px solid #667eea;
        }
        .summary-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 20px;
        }
        .summary-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            min-height: 100px;
            margin-top: 10px;
            line-height: 1.6;
            word-break: break-word;
        }
        .loading {
            text-align: center;
            color: #667eea;
            font-size: 14px;
            margin-top: 10px;
        }
        .empty-state {
            text-align: center;
            color: #6c757d;
            padding: 40px 20px;
            font-size: 16px;
        }
        .empty-state p { margin-top: 10px; }
        .import-export-section {
            margin-top: 25px;
            padding: 20px;
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            border-radius: 15px;
            border: 2px solid #ffc107;
        }
        .import-export-section h2 {
            color: #e67e22;
            margin-bottom: 15px;
            font-size: 20px;
        }
        .import-export-btns {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .import-export-btns .btn {
            flex: 1;
            padding: 10px 15px;
            font-size: 14px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .modal h3 {
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #e9ecef;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
        }
        .data-info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
        }
        .data-info p { margin: 8px 0; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-value { font-size: 28px; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 13px; opacity: 0.9; }
        @media (max-width: 768px) {
            .btn-group, .import-export-btns { flex-direction: column; }
            .btn { width: 100%; }
            .stats-bar { font-size: 12px; }
            .history-controls { flex-direction: column; }
            .month-view { grid-template-columns: repeat(7, 1fr); }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="settings-btn" onclick="window.location.href='settings.html'">âš™ï¸</button>
            <h1>âœ¨ å°æ€æ—¥è®° âœ¨</h1>
            <p>æ¯å¤©è®°å½•æƒ³æ³•ï¼Œè®©AIå¸®ä½ æ‰¾åˆ°å¯å˜ç°çš„è·¯å­</p>
            <div class="stats-bar" id="statsBar">
                <span>ğŸ“ è®°å½•: 0æ¡</span>
                <span>ğŸ“… æœ€æ—©: -</span>
                <span>ğŸ†• æœ€æ–°: -</span>
            </div>
        </div>

        <!-- æ ‡ç­¾åˆ‡æ¢ -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('today')">ğŸ“ ä»Šæ—¥</button>
            <button class="tab-btn" onclick="switchTab('history')">ğŸ“š å†å²</button>
            <button class="tab-btn" onclick="switchTab('calendar')">ğŸ“… æœˆä»½</button>
        </div>

        <div class="content">
            <!-- ä»Šæ—¥è®°å½• -->
            <div id="todayTab" class="tab-content active">
                <div class="record-section">
                    <h2>ğŸ’¡ è®°å½•æ­¤åˆ»çš„æƒ³æ³•</h2>
                    <textarea id="recordInput" placeholder="å†™ä¸‹ä½ çš„æƒ³æ³•ã€çµæ„Ÿæˆ–æ„Ÿæ‚Ÿ..."></textarea>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="saveRecord()">
                            <span>ğŸ’¾</span> ä¿å­˜
                        </button>
                        <button class="btn btn-secondary" onclick="clearInput()">
                            <span>ğŸ—‘ï¸</span> æ¸…ç©º
                        </button>
                    </div>
                </div>

                <div class="summary-section">
                    <h2>ğŸ¤– ä¸€é”®æ™ºèƒ½æ€»ç»“</h2>
                    <button class="btn btn-primary" onclick="generateSummary()" style="width:100%;">
                        <span>ğŸš€</span> ç”Ÿæˆä»Šæ—¥æ€»ç»“ä¸å˜ç°å»ºè®®
                    </button>
                    <div id="summaryContent" class="summary-content">
                        <p style="color:#6c757d;">ç‚¹å‡»æŒ‰é’®ï¼ŒAIå°†å¸®ä½ åˆ†æä»Šå¤©çš„è®°å½•ï¼Œç”Ÿæˆå¯å˜ç°çš„å†…å®¹å»ºè®®...</p>
                    </div>
                    <div id="loading" class="loading" style="display:none;">ğŸ”„ AIæ­£åœ¨æ€è€ƒä¸­...</div>
                </div>

                <div class="import-export-section">
                    <h2>ğŸ’¾ å¤‡ä»½ä¸æ¢å¤</h2>
                    <p style="color:#212529; margin-bottom:15px;">å®šæœŸå¤‡ä»½æ•°æ®ï¼Œé˜²æ­¢ä¸¢å¤±</p>
                    <div class="import-export-btns">
                        <button class="btn btn-success" onclick="exportData()">
                            <span>ğŸ“¤</span> å¯¼å‡ºå…¨éƒ¨
                        </button>
                        <button class="btn btn-warning" onclick="document.getElementById('importFile').click()">
                            <span>ğŸ“¥</span> å¯¼å…¥æ•°æ®
                        </button>
                    </div>
                    <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importData(event)">
                </div>

                <div class="records-list">
                    <h2>
                        <span>ğŸ“– ä»Šæ—¥è®°å½•</span>
                        <button class="btn btn-secondary" style="padding:6px 12px; font-size:13px;" onclick="clearAllRecords()">
                            ğŸ—‘ï¸ æ¸…ç©ºä»Šæ—¥
                        </button>
                    </h2>
                    <div id="todayRecordsContainer"></div>
                </div>
            </div>

            <!-- å†å²è®°å½• -->
            <div id="historyTab" class="tab-content">
                <div class="records-list">
                    <h2>ğŸ“š å†å²è®°å½•</h2>
                    
                    <div class="history-controls">
                        <input type="date" class="date-picker" id="datePicker" onchange="filterByDate()">
                        <input type="text" class="search-box" id="searchBox" placeholder="æœç´¢è®°å½•å†…å®¹..." oninput="searchHistory()">
                    </div>
                    
                    <div id="historyRecordsContainer"></div>
                </div>
            </div>

            <!-- æœˆä»½è§†å›¾ -->
            <div id="calendarTab" class="tab-content">
                <div class="records-list">
                    <h2>ğŸ“… æœˆä»½è§†å›¾</h2>
                    
                    <div class="month-nav">
                        <button class="btn btn-secondary" style="width:auto;" onclick="changeMonth(-1)">â®</button>
                        <div class="month-title" id="monthTitle">2024å¹´1æœˆ</div>
                        <button class="btn btn-secondary" style="width:auto;" onclick="changeMonth(1)">â¯</button>
                    </div>
                    
                    <div class="month-view">
                        <div class="month-day-name">æ—¥</div>
                        <div class="month-day-name">ä¸€</div>
                        <div class="month-day-name">äºŒ</div>
                        <div class="month-day-name">ä¸‰</div>
                        <div class="month-day-name">å››</div>
                        <div class="month-day-name">äº”</div>
                        <div class="month-day-name">å…­</div>
                        <!-- æ—¥æœŸå°†åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    
                    <div id="monthRecordsContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ•°æ®ä¿¡æ¯å¼¹çª— -->
    <div id="dataModal" class="modal" onclick="event.target.id==='dataModal' && closeModal()">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">Ã—</button>
            <h3>ğŸ“Š æˆ‘çš„æ•°æ®</h3>
            <div class="data-info" id="dataInfo"></div>
            <button class="btn btn-primary" style="width:100%;" onclick="closeModal()">ç¡®å®š</button>
        </div>
    </div>

    <script>
        // Service Worker æ³¨å†Œ
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .catch(err => console.log('SWæ³¨å†Œå¤±è´¥:', err));
            });
        }

        // å…¨å±€å˜é‡
        let currentMonth = new Date();
        let filteredHistory = [];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadRecords();
            loadSettings();
            updateStats();
            renderMonthView();
        });

        // ==================== æ ‡ç­¾åˆ‡æ¢ ====================
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            // å¦‚æœåˆ‡æ¢åˆ°å†å²è®°å½•ï¼ŒåŠ è½½æ•°æ®
            if (tabName === 'history') {
                loadHistoryRecords();
            } else if (tabName === 'calendar') {
                renderMonthView();
            }
        }

        // ==================== æ ¸å¿ƒåŠŸèƒ½ ====================

        // åŠ è½½è®¾ç½®
        function loadSettings() {
            const saved = localStorage.getItem('xiaosiSettings');
            window.apiSettings = saved ? JSON.parse(saved) : {
                apiKey: '',
                apiModel: 'deepseek-chat',
                apiUrl: 'https://api.deepseek.com/v1/chat/completions'
            };
        }

        // ä¿å­˜è®°å½•
        function saveRecord() {
            const content = document.getElementById('recordInput').value.trim();
            if (!content) {
                alert('ğŸ“ è¯·è¾“å…¥è¦è®°å½•çš„å†…å®¹ï¼');
                return;
            }

            const now = new Date();
            const record = {
                id: Date.now(),
                content: content,
                timestamp: now.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }),
                date: now.toLocaleDateString('zh-CN'),
                createdAt: now.toISOString()
            };

            const records = JSON.parse(localStorage.getItem('xiaosiRecords') || '[]');
            records.unshift(record);
            localStorage.setItem('xiaosiRecords', JSON.stringify(records));

            document.getElementById('recordInput').value = '';
            loadRecords();
            updateStats();
            renderMonthView();
            alert('âœ… è®°å½•ä¿å­˜æˆåŠŸï¼');
        }

        // æ¸…ç©ºè¾“å…¥æ¡†
        function clearInput() {
            document.getElementById('recordInput').value = '';
        }

        // ==================== ä»Šæ—¥è®°å½• ====================

        // åŠ è½½ä»Šæ—¥è®°å½•
        function loadRecords() {
            const container = document.getElementById('todayRecordsContainer');
            const records = JSON.parse(localStorage.getItem('xiaosiRecords') || '[]');
            const today = new Date().toLocaleDateString('zh-CN');
            const todayRecords = records.filter(r => r.date === today);
            
            if (todayRecords.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>ğŸ’­ è¿˜æ²¡æœ‰è®°å½•å‘¢ï¼Œå¼€å§‹è®°å½•ä½ çš„æƒ³æ³•å§ï¼</p>
                        <p>æ‰€æœ‰æ•°æ®éƒ½ä¿å­˜åœ¨ä½ çš„è®¾å¤‡ä¸Šï¼Œå®‰å…¨å¯é </p>
                    </div>
                `;
                return;
            }

            let html = '';
            todayRecords.forEach(r => {
                html += `
                    <div class="record-item">
                        <div class="record-time">ğŸ• ${r.timestamp}</div>
                        <div class="record-content">${escapeHtml(r.content)}</div>
                        <div class="record-actions">
                            <button class="record-btn edit-btn" onclick="editRecord(${r.id})">âœï¸ ç¼–è¾‘</button>
                            <button class="record-btn delete-btn" onclick="deleteRecord(${r.id})">ğŸ—‘ï¸ åˆ é™¤</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // ==================== å†å²è®°å½• ====================

        // åŠ è½½å†å²è®°å½•
        function loadHistoryRecords() {
            const container = document.getElementById('historyRecordsContainer');
            const records = JSON.parse(localStorage.getItem('xiaosiRecords') || '[]');
            
            if (records.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>ğŸ“­ è¿˜æ²¡æœ‰å†å²è®°å½•</p>
                        <p>å¼€å§‹è®°å½•ï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºä½ çš„æˆé•¿è½¨è¿¹</p>
                    </div>
                `;
                filteredHistory = [];
                return;
            }
            
            // æŒ‰æ—¥æœŸåˆ†ç»„
            const grouped = {};
            records.forEach(r => {
                if (!grouped[r.date]) {
                    grouped[r.date] = [];
                }
                grouped[r.date].push(r);
            });
            
            // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°åœ¨å‰ï¼‰
            const dates = Object.keys(grouped).sort((a, b) => {
                return new Date(b) - new Date(a);
            });
            
            filteredHistory = dates.map(date => ({
                date: date,
                records: grouped[date]
            }));
            
            renderHistoryList();
        }

        // æ¸²æŸ“å†å²è®°å½•åˆ—è¡¨
        function renderHistoryList() {
            const container = document.getElementById('historyRecordsContainer');
            let html = '';
            
            filteredHistory.forEach(item => {
                html += `
                    <div class="history-item">
                        <div class="history-date">ğŸ“… ${item.date}</div>
                `;
                
                item.records.forEach(r => {
                    html += `
                        <div class="history-record">
                            <div class="history-time">ğŸ• ${r.timestamp.split(' ')[1] || r.timestamp}</div>
                            <div class="history-content">${escapeHtml(r.content)}</div>
                            <div class="history-actions">
                                <button class="record-btn view-btn" onclick="viewRecord(${r.id})">ğŸ‘ï¸ é¢„è§ˆ</button>
                                <button class="record-btn edit-btn" onclick="editRecord(${r.id})">âœï¸ ç¼–è¾‘</button>
                                <button class="record-btn delete-btn" onclick="deleteRecord(${r.id})">ğŸ—‘ï¸ åˆ é™¤</button>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            container.innerHTML = html;
        }

        // æŒ‰æ—¥æœŸç­›é€‰
        function filterByDate() {
            const selectedDate = document.getElementById('datePicker').value;
            if (!selectedDate) {
                loadHistoryRecords();
                return;
            }
            
            // è½¬æ¢ä¸ºä¸­æ–‡æ—¥æœŸæ ¼å¼
            const date = new Date(selectedDate);
            const formattedDate = date.toLocaleDateString('zh-CN');
            
            const allRecords = JSON.parse(localStorage.getItem('xiaosiRecords') || '[]');
            const filtered = allRecords.filter(r => r.date === formattedDate);
            
            if (filtered.length === 0) {
                document.getElementById('historyRecordsContainer').innerHTML = `
                    <div class="empty-state">
                        <p>ğŸ“­ è¿™ä¸€å¤©æ²¡æœ‰è®°å½•</p>
                    </div>
                `;
                filteredHistory = [];
                return;
            }
            
            // æŒ‰æ—¶é—´æ’åº
            filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            filteredHistory = [{
                date: formattedDate,
                records: filtered
            }];
            
            renderHistoryList();
        }

        // æœç´¢å†å²è®°å½•
        function searchHistory() {
            const keyword = document.getElementById('searchBox').value.trim().toLowerCase();
            if (!keyword) {
                loadHistoryRecords();
                return;
            }
            
            const allRecords = JSON.parse(localStorage.getItem('xiaosiRecords') || '[]');
            const matched = allRecords.filter(r => 
                r.content.toLowerCase().includes(keyword)
            );
            
            if (matched.length === 0) {
                document.getElementById('historyRecordsContainer').innerHTML = `
                    <div class="empty-state">
                        <p>ğŸ” æ²¡æœ‰æ‰¾åˆ°åŒ…å« "${keyword}" çš„è®°å½•</p>
                    </div>
                `;
                filteredHistory = [];
                return;
            }
            
            // æŒ‰æ—¥æœŸåˆ†ç»„
            const grouped = {};
            matched.forEach(r => {
                if (!grouped[r.date]) {
                    grouped[r.date] = [];
                }
                grouped[r.date].push(r);
            });
            
            // æŒ‰æ—¥æœŸæ’åº
            const dates = Object.keys(grouped).sort((a, b) => {
                return new Date(b) - new Date(a);
            });
            
            filteredHistory = dates.map(date => ({
                date: date,
                records: grouped[date]
            }));
            
            renderHistoryList();
        }

        // ==================== æœˆä»½è§†å›¾ ====================

        // æ¸²æŸ“æœˆä»½è§†å›¾
        function renderMonthView() {
            const monthView = document.querySelector('.month-view');
            const monthTitle = document.getElementById('monthTitle');
            
            // æ›´æ–°æœˆä»½æ ‡é¢˜
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth() + 1;
            monthTitle.textContent = `${year}å¹´${month}æœˆ`;
            
            // æ¸…ç©ºæ—¥æœŸï¼ˆä¿ç•™æ˜ŸæœŸæ ‡é¢˜ï¼‰
            const daysContainer = Array.from(monthView.children).slice(7);
            daysContainer.forEach(day => day.remove());
            
            // è·å–å½“æœˆç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå‡ 
            const firstDay = new Date(year, currentMonth.getMonth(), 1);
            const startDay = firstDay.getDay(); // 0=å‘¨æ—¥, 6=å‘¨å…­
            
            // è·å–å½“æœˆå¤©æ•°
            const lastDay = new Date(year, currentMonth.getMonth() + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            // è·å–æ‰€æœ‰è®°å½•çš„æ—¥æœŸ
            const allRecords = JSON.parse(localStorage.getItem('xiaosiRecords') || '[]');
            const recordDates = {};
            allRecords.forEach(r => {
                recordDates[r.date] = true;
            });
            
            const today = new Date().toLocaleDateString('zh-CN');
            
            // å¡«å……æ—¥æœŸ
            // ç©ºç™½å ä½
            for (let i = 0; i < startDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'month-day';
                emptyDay.style.backgroundColor = 'transparent';
                emptyDay.style.border = 'none';
                monthView.appendChild(emptyDay);
            }
            
            // æ—¥æœŸ
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = new Date(year, currentMonth.getMonth(), day).toLocaleDateString('zh-CN');
                const dayEl = document.createElement('div');
                dayEl.className = 'month-day';
                dayEl.textContent = day;
                
                // æ ‡è®°æœ‰è®°å½•çš„æ—¥æœŸ
                if (recordDates[dateStr]) {
                    dayEl.classList.add('has-record');
                }
                
                // æ ‡è®°ä»Šå¤©
                if (dateStr === today) {
                    dayEl.classList.add('today');
                }
                
                dayEl.onclick = () => {
                    document.getElementById('datePicker').value = formatDateForInput(new Date(year, currentMonth.getMonth(), day));
                    filterByDate();
                    switchTab('history');
                };
                
                monthView.appendChild(dayEl);
            }
        }

        // æ”¹å˜æœˆä»½
        function changeMonth(delta) {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            renderMonthView();
        }

        // æ ¼å¼åŒ–æ—¥æœŸä¸º input[type=date] æ ¼å¼
        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // ==================== è®°å½•æ“ä½œ ====================

        // ç¼–è¾‘è®°å½•
        function editRecord(id) {
            const records = JSON.parse(localStorage.getItem('xiaosiRecords') || '[]');
            const record = records.find(r => r.id == id);
            if (record) {
                const newContent = prompt('âœï¸ ç¼–è¾‘è®°å½•å†…å®¹ï¼š', record.content);
                if (newContent !== null && newContent.trim() !== '') {
                    record.content = newContent.trim();
                    localStorage.setItem('xiaosiRecords', JSON.stringify(records));
                    loadRecords();
                    loadHistoryRecords();
                    updateStats();
                    renderMonthView();
                    alert('âœ… è®°å½•æ›´æ–°æˆåŠŸï¼');
                }
            }
        }

        // åˆ é™¤è®°å½•
        function deleteRecord(id) {
            if (!confirm('ğŸ—‘ï¸ ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return;
            let records = JSON.parse(localStorage.getItem('xiaosiRecords') || '[]');
            records = records.filter(r => r.id != id);
            localStorage.setItem('xiaosiRecords', JSON.stringify(records));
            loadRecords();
            loadHistoryRecords();
            updateStats();
            renderMonthView();
            alert('âœ… è®°å½•åˆ é™¤æˆåŠŸï¼');
        }

        // æŸ¥çœ‹è®°å½•ï¼ˆé¢„è§ˆï¼‰
        function viewRecord(id) {
            const records = JSON.parse(localStorage.getItem('xiaosiRecords') || '[]');
            const record = records.find(r => r.id == id);
            if (record) {
                alert(`ğŸ“… æ—¥æœŸï¼š${record.date}\nğŸ• æ—¶é—´ï¼š${record.timestamp}\n\nğŸ“ å†…å®¹ï¼š\n${record.content}`);
            }
        }

        // æ¸…ç©ºä»Šæ—¥è®°å½•
        function clearAllRecords() {
            if (!confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºä»Šå¤©çš„æ‰€æœ‰è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            
            const today = new Date().toLocaleDateString('zh-CN');
            let records = JSON.parse(localStorage.getItem('xiaosiRecords') || '[]');
            records = records.filter(r => r.date !== today);
            localStorage.setItem('xiaosiRecords', JSON.stringify(records));
            
            loadRecords();
            loadHistoryRecords();
            updateStats();
            renderMonthView();
            alert('âœ… ä»Šæ—¥è®°å½•å·²æ¸…ç©ºï¼');
        }

        // ==================== æ™ºèƒ½æ€»ç»“ ====================

        // ç”Ÿæˆæ™ºèƒ½æ€»ç»“
        async function generateSummary() {
            const records = JSON.parse(localStorage.getItem('xiaosiRecords') || '[]');
            const today = new Date().toLocaleDateString('zh-CN');
            const todayRecords = records.filter(r => r.date === today);
            
            if (todayRecords.length === 0) {
                alert('ğŸ’­ è¿˜æ²¡æœ‰ä»Šå¤©çš„è®°å½•å‘¢ï¼Œè¯·å…ˆè®°å½•ä¸€äº›æƒ³æ³•ï¼');
                return;
            }

            const summaryContent = document.getElementById('summaryContent');
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            summaryContent.innerHTML = '';

            try {
                const recordsText = todayRecords.map(r => r.content).join('\n\n');
                const prompt = `è¯·åˆ†æä»¥ä¸‹ä»Šå¤©çš„æ—¥è®°è®°å½•ï¼Œå¸®æˆ‘ç”Ÿæˆä¸€ä¸ªæ€»ç»“ï¼Œå¹¶æä¾›å¯å˜ç°çš„å†…å®¹å»ºè®®ï¼ˆæ¯”å¦‚vlogè„šæœ¬ã€æ–‡ç« ä¸»é¢˜ã€äº§å“åˆ›æ„ç­‰ï¼‰ï¼š

ä»Šå¤©çš„è®°å½•ï¼š
${recordsText}

è¯·æŒ‰ç…§ä»¥ä¸‹æ ¼å¼å›å¤ï¼š
1. ä»Šæ—¥æ€»ç»“ï¼šï¼ˆç®€è¦æ€»ç»“ä»Šå¤©çš„ä¸»è¦æƒ³æ³•å’Œæƒ…ç»ªï¼‰
2. å˜ç°å»ºè®®ï¼šï¼ˆæä¾›2-3ä¸ªå…·ä½“çš„å¯å˜ç°å†…å®¹åˆ›æ„ï¼ŒåŒ…æ‹¬å½¢å¼å’Œä¸»é¢˜ï¼‰
3. è¡ŒåŠ¨å»ºè®®ï¼šï¼ˆç»™å‡º1-2ä¸ªå…·ä½“çš„ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®®ï¼‰`;

                const response = await callAI(prompt);
                summaryContent.innerHTML = `<p>${escapeHtml(response).replace(/\n/g, '<br>')}</p>`;
            } catch (error) {
                summaryContent.innerHTML = `<p style="color:#dc3545;">âŒ ${error.message}</p>`;
            } finally {
                loading.style.display = 'none';
            }
        }

        // è°ƒç”¨AI API
        async function callAI(prompt) {
            if (!window.apiSettings || !window.apiSettings.apiKey) {
                throw new Error('è¯·å…ˆåœ¨è®¾ç½®é¡µé¢é…ç½®APIå¯†é’¥');
            }

            const res = await fetch(window.apiSettings.apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${window.apiSettings.apiKey}`
                },
                body: JSON.stringify({
                    model: window.apiSettings.apiModel || 'deepseek-chat',
                    messages: [
                        {role:'system',content:'ä½ æ˜¯ä¸€ä¸ªå¸®åŠ©ç”¨æˆ·åˆ†ææ—¥è®°å¹¶æä¾›å»ºè®®çš„AIåŠ©æ‰‹ã€‚'},
                        {role:'user',content:prompt}
                    ],
                    temperature: 0.7,
                    max_tokens: 1000
                })
            });

            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.error?.message || 'APIè°ƒç”¨å¤±è´¥');
            }

            const data = await res.json();
            return data.choices[0].message.content;
        }

        // ==================== å¯¼å‡º/å¯¼å…¥åŠŸèƒ½ ====================

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const records = JSON.parse(localStorage.getItem('xiaosiRecords') || '[]');
            const settings = JSON.parse(localStorage.getItem('xiaosiSettings') || '{}');
            
            const exportData = {
                version: '1.0',
                exportedAt: new Date().toISOString(),
                records: records,
                settings: settings,
                totalRecords: records.length
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `å°æ€æ—¥è®°å¤‡ä»½-${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            alert(`âœ… å¤‡ä»½æˆåŠŸï¼\nå…± ${records.length} æ¡è®°å½•å·²å¯¼å‡º`);
        }

        // å¯¼å…¥æ•°æ®
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.records) {
                        alert('âŒ æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼');
                        return;
                    }
                    
                    const oldRecords = JSON.parse(localStorage.getItem('xiaosiRecords') || '[]');
                    const newRecordsCount = data.records.length;
                    const oldRecordsCount = oldRecords.length;
                    
                    if (oldRecordsCount > 0) {
                        if (!confirm(`âš ï¸ å½“å‰å·²æœ‰ ${oldRecordsCount} æ¡è®°å½•\nå¯¼å…¥å°†è¦†ç›–ç°æœ‰æ•°æ®ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ`)) {
                            return;
                        }
                    }
                    
                    // å¯¼å…¥è®°å½•
                    localStorage.setItem('xiaosiRecords', JSON.stringify(data.records));
                    
                    // å¯¼å…¥è®¾ç½®ï¼ˆå¯é€‰ï¼‰
                    if (data.settings) {
                        localStorage.setItem('xiaosiSettings', JSON.stringify(data.settings));
                        loadSettings();
                    }
                    
                    loadRecords();
                    loadHistoryRecords();
                    updateStats();
                    renderMonthView();
                    
                    alert(`âœ… å¯¼å…¥æˆåŠŸï¼\nå…±å¯¼å…¥ ${newRecordsCount} æ¡è®°å½•`);
                    
                } catch (error) {
                    alert(`âŒ å¯¼å…¥å¤±è´¥ï¼š${error.message}`);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ==================== ç»Ÿè®¡ä¿¡æ¯ ====================

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const records = JSON.parse(localStorage.getItem('xiaosiRecords') || '[]');
            
            if (records.length === 0) {
                document.getElementById('statsBar').innerHTML = `
                    <span>ğŸ“ è®°å½•: 0æ¡</span>
                    <span>ğŸ“… æœ€æ—©: -</span>
                    <span>ğŸ†• æœ€æ–°: -</span>
                `;
                return;
            }
            
            // æŒ‰æ—¶é—´æ’åº
            records.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
            
            const earliest = records[0];
            const latest = records[records.length - 1];
            
            // è®¡ç®—æ´»è·ƒå¤©æ•°
            const dates = new Set(records.map(r => r.date));
            const activeDays = dates.size;
            
            // æ ¼å¼åŒ–æ—¥æœŸï¼ˆåªæ˜¾ç¤ºæœˆæ—¥ï¼‰
            const formatDate = (dateStr) => {
                const date = new Date(dateStr);
                return date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });
            };
            
            document.getElementById('statsBar').innerHTML = `
                <span>ğŸ“ è®°å½•: ${records.length}æ¡</span>
                <span>ğŸ“… æ´»è·ƒ: ${activeDays}å¤©</span>
                <span>ğŸ†• ${formatDate(latest.createdAt)}</span>
            `;
        }

        // ==================== å·¥å…·å‡½æ•° ====================

        // é˜²æ­¢XSSæ”»å‡»
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // å…³é—­å¼¹çª—
        function closeModal() {
            document.getElementById('dataModal').style.display = 'none';
        }
    </script>
</body>
</html>